#!/usr/bin/env python3

# Author: @edurso
# Python Script to Automatically Update the GitHub CLI on Linux

# Imports
import shutil
import json
import wget
import os

# Define Constants
GH_URL       = 'https://api.github.com/repos/cli/cli/releases/latest'
INSTALL_DIR  = '/home/edurso/install/'
FNAME        = 'latest'
VERSION_TAG  = 'tag_name'

# Function to Find Values by JSON ID
def find_values(id, json_repr):
    results = []
    def _decode_dict(a_dict):
        try:
            results.append(a_dict[id])
        except KeyError:
            pass
        return a_dict
    json.loads(json_repr, object_hook=_decode_dict)
    return results

# Retrieve Latest Release Information
wget.download(GH_URL, INSTALL_DIR)

# Extract Latest Version From Latest Release Information
version = None
with open(INSTALL_DIR + FNAME, 'r') as file:
    data = file.read().replace('\n', '')
    version = find_values(VERSION_TAG, data).pop()

# Now We Know What Version We Are Installing . . . 
print('\nInstalling', version, 'of the GitHub CLI')

# Use Version Information to get the Latest Package (as a .tar.gz)
compressed_file_url = 'https://github.com/cli/cli/releases/download/' + version + '/gh_' + version[1:] + '_linux_amd64.tar.gz'

# Download the Latest Package
wget.download(compressed_file_url, INSTALL_DIR)

# Extract the Latest Package
os.system('tar -xvf ' + INSTALL_DIR + 'gh_' + version[1:] + '_linux_amd64.tar.gz -C ' + INSTALL_DIR)

# Cpoy The Binaries
os.system('sudo cp ' + INSTALL_DIR + 'gh_' + version[1:] + '_linux_amd64/bin/gh /usr/local/bin/')

# Copy the Manual
os.system('sudo cp -r ' + INSTALL_DIR + 'gh_' + version[1:] + '_linux_amd64/share/man/man1/* /usr/share/man/man1/')

# Clean Up From Install
os.remove(INSTALL_DIR + FNAME)
os.remove(INSTALL_DIR + 'gh_' + version[1:] + '_linux_amd64.tar.gz')
shutil.rmtree(INSTALL_DIR + 'gh_' + version[1:] + '_linux_amd64')

